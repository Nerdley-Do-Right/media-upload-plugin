<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>RemoteUpload</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage RemoteUploadConfigPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <h1>Media-Upload-Plugin</h1>
                <form id="SetUploadDirectory" enctype="multipart/form-data" action="/mediaupload/directory">
                    <div class="inputContainer">
                        <div style="display: flex; align-items: center;">
                            <div style="flex-grow:1;">
                                <label class="inputLabel inputLabel-float inputLabelUnfocused" for="downloadpathfolder">Folder</label>
                                <input is="emby-input" id="uploadpathfolder" name="path" type="text" required class="emby-input" placeholder="Folder path" />
                            </div>
                            <button type="submit" class="emby-input-iconbutton paper-icon-button-light" title="Browse">
                                <span class="material-icons search" aria-hidden="true"></span>
                            </button>
                        </div>
                    </div>

                    <div id="uploadFolderContentDisplay" class="results paperList" style="margin-top: 1em; max-height: 300px; overflow-y: auto;">
                        <!-- Files/Folders get inserted here by JS -->
                    </div>
                </form>
                <form id="RemoteUploadForm">
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span id="directory_button">Save</span>
                        </button>
                    </div>
                    <br>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="uploaddir">Choose upload directory</label>
                        <ul id="uploaddirslist" style="padding-left: 0; margin-top: 0; list-style-position: inside;"></ul>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var RemoteUploadConfig = {
                pluginUniqueId: 'b5a2d6b3-c5f4-4f88-aed4-5f3e9877d0a6',
            };

            document.querySelector(".RemoteUploadConfigPage").addEventListener("pageshow", async function () {
                updateUI();
            });

            async function fetchWithAuth(url, method, body) {
                const reqInit = {
                    method: method,
                    headers: {
                        Authorization: "MediaBrowser Token=" + ApiClient.accessToken(),
                    },
                    body: body,
                };

                return await fetch(url, reqInit);
            }

            function updateUI() {
                ApiClient.getPluginConfiguration(RemoteUploadConfig.pluginUniqueId).then(function (config) {
                    // Update placeholder
                    document.getElementById('uploadpathfolder').setAttribute("placeholder", config.uploaddir);

                    // Clear and populate list
                    const list = document.getElementById('uploaddirslist');
                    list.innerHTML = "";
                    config.uploaddirs.forEach(function (dir) {
                        const li = document.createElement('li');
                        li.style.display = "flex";
                        li.style.justifyContent = "space-between";
                        li.style.alignItems = "center";
                        
                        const span = document.createElement('span');
                        span.textContent = dir;
                        span.style.cursor = "pointer";

                        if (dir === config.uploaddir) {
                            li.style.listStyleType = "disc";
                        }
                        else {
                            li.style.listStyleType = "circle";
                        }

                        span.addEventListener("click", function () {
                            config.uploaddir = dir;
                            document.getElementById('uploadpathfolder').setAttribute("placeholder", dir);
                            ApiClient.updatePluginConfiguration(RemoteUploadConfig.pluginUniqueId, config).then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                                updateUI();
                            });
                        });

                        // Remove button
                        const removeBtn = document.createElement('p');
                        removeBtn.textContent = "Ã—";
                        removeBtn.style.border = "none";
                        removeBtn.style.background = "none";
                        removeBtn.style.cursor = "pointer";
                        removeBtn.style.color = "red";
                        removeBtn.style.fontSize = "1.2em";
                        removeBtn.style.margin = "0";

                        removeBtn.addEventListener("click", function () {
                            config.uploaddirs = config.uploaddirs.filter(p => p !== dir);
                            if (config.uploaddir === dir) {
                                config.uploaddir = config.uploaddirs[0] || "";
                            }
                            ApiClient.updatePluginConfiguration(RemoteUploadConfig.pluginUniqueId, config).then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                                updateUI();
                            });
                        });

                        li.appendChild(span);
                        li.appendChild(removeBtn);
                        list.appendChild(li);
                    });

                    Dashboard.hideLoadingMsg();
                });
            }

            document.querySelector("#RemoteUploadForm").addEventListener('submit', function (e) {
                e.preventDefault();

                ApiClient.getPluginConfiguration(RemoteUploadConfig.pluginUniqueId).then(function (config) {
                    const newDir = document.getElementById('uploadpathfolder').value.trim();
                    if (newDir && !config.uploaddirs.includes(newDir)) {
                        config.uploaddirs.push(newDir);
                    }
                    config.uploaddir = newDir || config.uploaddir;
                    document.getElementById('uploadpathfolder').value = "";
                    document.getElementById('uploadpathfolder').setAttribute("placeholder", config.uploaddir);

                    ApiClient.updatePluginConfiguration(RemoteUploadConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        updateUI();
                    });
                });

                return false;
            });

            document.querySelector("#SetUploadDirectory").addEventListener("submit", async function(e) {
                e.preventDefault();
                await listUploadDirectory();
            })
            async function listUploadDirectory() {
                    const scrollTop = window.scrollY;

                    const pathInput = document.getElementById("uploadpathfolder");
                    let oldPath = pathInput.value.trim().replace(/\\/g, "/");
                    if (!oldPath.endsWith("/")) oldPath += "/";
                    pathInput.value = oldPath;

                    const formData = new FormData(document.querySelector("#SetUploadDirectory"));
                    document.getElementById("uploadFolderContentDisplay").innerHTML = "";
                    const res = await fetchWithAuth(document.querySelector("#SetUploadDirectory").action, "POST", formData)
                    if (res.ok) {
                        let files = await res.json();

                        let oldPath = document.getElementById("uploadpathfolder").value;
                        if (!oldPath.endsWith("/")) {
                            oldPath += "/";
                        }

                        // Up element
                        const upElement = document.createElement("div");
                        upElement.className = "listItem listItem-border lnkPath lnkDirectory";
                        upElement.setAttribute("data-type", "Directory");
                        upElement.setAttribute("data-path", "..");
                        upElement.style.cursor = "pointer";

                        // Inner body
                        let upBody = document.createElement("div");
                        upBody.className = "listItemBody";
                        upBody.style.paddingLeft = "0";
                        upBody.style.paddingTop = ".5em";
                        upBody.style.paddingBottom = ".5em";

                        // Text
                        let upText = document.createElement("div");
                        upText.className = "listItemBodyText";
                        upText.textContent = "..";

                        // Compose
                        upBody.appendChild(upText);
                        upElement.appendChild(upBody);

                        // Arrow
                        let upArrow = document.createElement("span");
                        upArrow.className = "material-icons arrow_forward";
                        upArrow.setAttribute("aria-hidden", "true");
                        upArrow.style.fontSize = "inherit";
                        upElement.appendChild(upArrow);

                        // Behavior: go up one directory
                        upElement.onclick = async function () {
                            let currentPath = document.getElementById("uploadpathfolder").value.trim().replace(/\/+$/, "");
                            const segments = currentPath.split("/");
                            if (segments.length > 1) {
                                segments.pop(); // remove last folder
                                document.getElementById("uploadpathfolder").value = segments.join("/") + "/";
                                await listUploadDirectory();
                            }
                        };

                        document.querySelector("#uploadFolderContentDisplay").appendChild(upElement);

                        for (let i = 0; i<files.length; i++) {
                            const path = files[i];
                            const isFolder = path.endsWith("/");
                            
                            if (!isFolder) {
                                continue;
                            }

                            // Wrapper div
                            let element = document.createElement("div");
                            element.className = "listItem listItem-border lnkPath";
                            element.setAttribute("data-type", isFolder ? "Directory" : "File");
                            element.setAttribute("data-path", oldPath + path);
                            element.style.cursor = "pointer";

                            
                            element.classList.add("lnkDirectory");

                            // Inner body
                            let body = document.createElement("div");
                            body.className = "listItemBody";
                            body.style.paddingLeft = "0";
                            body.style.paddingTop = ".5em";
                            body.style.paddingBottom = ".5em";

                            // Text element
                            let text = document.createElement("div");
                            text.className = "listItemBodyText";
                            text.textContent = path;

                            // Compose
                            body.appendChild(text);
                            element.appendChild(body);

                            
                            let arrow = document.createElement("span");
                            arrow.className = "material-icons arrow_forward";
                            arrow.setAttribute("aria-hidden", "true");
                            arrow.style.fontSize = "inherit";
                            element.appendChild(arrow);

                            element.onclick = async function() {
                                document.getElementById("uploadpathfolder").value = oldPath + path;
                                document.getElementById("uploadpathfolder").blur();
                                await listUploadDirectory();
                            };

                            // Add to container
                            document.querySelector("#uploadFolderContentDisplay").appendChild(element);
                        }
                        window.scrollTo(0, scrollTop);
                        
                        return;
                    }
                    else {
                        const result = await res.json();
                        document.querySelector("#directory_button").innerText = result.message || "Server error!";
                        return;
                    }
            }
        </script>
    </div>
</body>
</html>